# ============================================================
# Alpha Monorepo — Nginx Reverse Proxy Configuration
# ============================================================
#
# Copy this file to /etc/nginx/sites-available/alpha.conf
# then symlink: ln -s /etc/nginx/sites-available/alpha.conf /etc/nginx/sites-enabled/
#
# After copying, run:
#   1. Replace YOUR_DOMAIN with your actual domain
#   2. sudo nginx -t          (test config)
#   3. sudo systemctl reload nginx
#   4. sudo certbot --nginx   (add SSL for all domains)
#
# ============================================================

# ── Shared upstream + proxy settings ──
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# ── Master Dashboard (port 3000) ──
server {
    listen 80;
    server_name master.YOUR_DOMAIN;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ── Invoice Downloader (port 3001) ──
server {
    listen 80;
    server_name invoices.YOUR_DOMAIN;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ── Invoice Processor (port 3002) ──
server {
    listen 80;
    server_name processor.YOUR_DOMAIN;

    location / {
        proxy_pass http://127.0.0.1:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ── Customer Responder (port 3004) ──
server {
    listen 80;
    server_name responder.YOUR_DOMAIN;

    location / {
        proxy_pass http://127.0.0.1:3004;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ── LibreChat (Docker — port 3080) ──
server {
    listen 80;
    server_name chat.YOUR_DOMAIN;

    client_max_body_size 25M;

    location / {
        proxy_pass http://127.0.0.1:3080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ── MCP SSE Endpoints (internal access only) ──
# Uncomment and adjust if you need external MCP access.
# Consider restricting with allow/deny directives or VPN.
#
# server {
#     listen 80;
#     server_name mcp.YOUR_DOMAIN;
#
#     # Invoice Processor MCP
#     location /invoice-processor/ {
#         proxy_pass http://127.0.0.1:4001/;
#         proxy_http_version 1.1;
#         proxy_set_header Connection '';
#         proxy_buffering off;
#         proxy_cache off;
#     }
#
#     # Invoice Downloader MCP
#     location /invoice-downloader/ {
#         proxy_pass http://127.0.0.1:4002/;
#         proxy_http_version 1.1;
#         proxy_set_header Connection '';
#         proxy_buffering off;
#         proxy_cache off;
#     }
#
#     # Gmail Labeler MCP
#     location /gmail-labeler/ {
#         proxy_pass http://127.0.0.1:4003/;
#         proxy_http_version 1.1;
#         proxy_set_header Connection '';
#         proxy_buffering off;
#         proxy_cache off;
#     }
#
#     # Customer Responder MCP
#     location /customer-responder/ {
#         proxy_pass http://127.0.0.1:4004/;
#         proxy_http_version 1.1;
#         proxy_set_header Connection '';
#         proxy_buffering off;
#         proxy_cache off;
#     }
# }
